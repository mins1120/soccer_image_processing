{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'home/style.css' %}">

<!-- ë°°ë„ˆ ì„¹ì…˜ -->
<section class="banner">
    <div class="container">
        <!-- ë°°ë„ˆ ë‚´ìš© ì¶”ê°€ -->
        <div class="banner-text">Soccer with entertain</div>
    </div>
</section>

<div class="button-container" style="display: flex; flex-direction: column; align-items: center; height: 100vh; margin-top: 10%;">
    <div class="row" style="width: 200px; margin-bottom: 20px;">
        <form id="upload-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="file" id="upload_video_file" name="upload_video_file" accept="video/*" style="display: none;">
        </form>
        <button id="upload-button" class="btn w-100" style="background-color: black; color: white;">Upload Video</button>
    </div>
    <div class="row" style="width: 200px;">
        <button id="download-button" class="btn w-100" style="background-color: black; color: white;">Download Video</button>
    </div>
</div>

<!-- ë‹¤ìš´ë¡œë“œ ëª¨ë‹¬ -->
<div id="downloadModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <h2>ë¹„ë””ì˜¤ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”</h2>
        <div class="video-list">
            {% for video in videos %}
                <div class="video-item" data-video-id="{{ video.id }}">
                    {% if video.download_video_file %}
                        <input type="radio" name="selected_video" value="{{ video.id }}" id="video_{{ video.id }}" style="display: none;">
                        <label for="video_{{ video.id }}">
                            <div class="video-details">
                                <div class="video-thumbnail">
                                    ğŸ¥
                                </div>
                                <div class="video-info">
                                    <strong>{{ video.upload_video_file.name }}</strong>
                                    <p>Uploaded at: {{ video.uploaded_at|date:"Y-m-d H:i" }}</p>
                                </div>
                            </div>
                        </label>
                    {% else %}
                        <!-- ì‘ì—… ì¤‘ì¸ ë¹„ë””ì˜¤ -->
                        <div class="video-details disabled" style="opacity: 0.5; pointer-events: none;">
                            <div class="video-thumbnail">
                                ğŸ› ï¸
                            </div>
                            <div class="video-info">
                                <strong>{{ video.upload_video_file.name }}</strong>
                                <p>Processing...</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        <button id="confirm-download" class="btn w-100" style="background-color: #007bff; color: white;">Download Video</button>
    </div>
</div>
<script>
    // ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ ì°½ì„ ì—½ë‹ˆë‹¤.
    document.getElementById('upload-button').addEventListener('click', function() {
        document.getElementById('upload_video_file').click();
    });

    // íŒŒì¼ ì„ íƒ í›„ AJAXë¡œ ì—…ë¡œë“œ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
    document.getElementById('upload_video_file').addEventListener('change', function() {
        const fileInput = this;
        
        if (fileInput.files.length === 0) {
            alert("No file selected. Please select a file to upload.");
            return;
        }

        const formData = new FormData();
        formData.append('upload_video_file', fileInput.files[0]);

        // CSRF í† í° ì„¤ì •
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // AJAX ìš”ì²­ ì „ì†¡
        fetch('', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken,  // CSRF í† í° ì¶”ê°€
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('File uploaded successfully!');
            } else {
                alert('File upload failed. Please try again.');
            }
            fileInput.value = '';  // ì„ íƒí•œ íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        })
        .catch(error => console.error('Error:', error));
    });
    // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì°½ì„ ì—½ë‹ˆë‹¤.
    document.getElementById('download-button').addEventListener('click', function() {
        document.getElementById('downloadModal').style.display = 'block';
    });

    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
    document.getElementById('closeModal').addEventListener('click', function() {
        document.getElementById('downloadModal').style.display = 'none';
    });

    // ë¹„ë””ì˜¤ í•­ëª© í´ë¦­ ì‹œ í•´ë‹¹ í•­ëª©ì„ ì„ íƒ
    document.querySelectorAll('.video-item').forEach(item => {
        item.addEventListener('click', function() {
            const videoId = this.getAttribute('data-video-id');
            document.getElementById('video_' + videoId).checked = true;

            // ì„ íƒëœ í•­ëª© ìŠ¤íƒ€ì¼ ë³€ê²½
            document.querySelectorAll('.video-item').forEach(el => el.classList.remove('selected'));
            this.classList.add('selected');
        });
    });

    // ë‹¤ìš´ë¡œë“œ í™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì„ íƒëœ ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
    document.getElementById('confirm-download').addEventListener('click', function() {
        const selectedVideo = document.querySelector('input[name="selected_video"]:checked');
        if (selectedVideo) {
            const videoId = selectedVideo.value;
            window.location.href = `/download/${videoId}/`;
        } else {
            alert("Please select a video to download.");
        }
    });
</script>
{% endblock %}